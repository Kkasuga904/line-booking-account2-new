# Vercel本番環境とローカルの違いによる問題

## 今日発生した「ローカルでは起きない」問題

### 1. 🔴 /api ディレクトリが認識されない問題
**症状:** 
- ローカル: `npx vercel dev` → ✅ /api/ping 正常動作
- Vercel: ❌ /api/ping → 404

**原因:**
- Framework Presetの誤認識（Next.jsと判定される）
- ビルド設定の問題
- vercel.jsonの複雑な設定

**解決策:**
- 新規プロジェクト作成が最速
- Framework Preset を「Other」に変更

### 2. 🔴 環境変数の反映タイミング
**症状:**
- ローカル: .env.localですぐ反映
- Vercel: 設定後も再デプロイが必要

**原因:**
- Vercelは環境変数をビルド時に読み込む
- 既存のデプロイには反映されない

**解決策:**
- 環境変数設定後は必ず再デプロイ
- または自動的に次回デプロイ時に反映

### 3. 🔴 デプロイ回数制限
**症状:**
- ローカル: 無制限にテスト可能
- Vercel: 100回/日の制限（無料プラン）

**原因:**
- 無料プランの制約
- デバッグで何度もデプロイすると枯渇

**解決策:**
- ローカルで十分テストしてからデプロイ
- 複数の変更をまとめてデプロイ
- 必要ならProプラン（6,000回/日）

## なぜローカルでは問題が起きないのか？

### ローカル開発サーバーの特徴
```bash
npx vercel dev
```
- ✅ ファイル変更を即座に反映
- ✅ 環境変数の即時読み込み
- ✅ Framework検出をスキップ
- ✅ デプロイ不要
- ✅ 回数制限なし

### Vercel本番環境の特徴
- ❌ デプロイが必要
- ❌ Framework自動検出が誤動作する場合あり
- ❌ ビルド設定の影響を受ける
- ❌ キャッシュの影響
- ❌ デプロイ回数制限

## 教訓とベストプラクティス

### 1. 初期設定は慎重に
```json
// vercel.json - シンプルに保つ
{}
```
- Framework Presetは最初に正しく設定
- 後から変更すると反映されない場合がある

### 2. ローカルテストの限界を理解
```bash
# これだけでは不十分
npx vercel dev  # ✅ 動作

# 本番でも確認が必要
vercel --prod   # 要確認
```

### 3. デプロイ戦略
- **開発初期**: 頻繁にデプロイして動作確認
- **安定後**: ローカルで完璧にしてからデプロイ
- **デバッグ時**: console.logを仕込んでからデプロイ（回数節約）

### 4. トラブル時の判断基準
```
ローカル ✅ + Vercel ❌ = Vercel設定問題
ローカル ❌ + Vercel ❌ = コードの問題
ローカル ❌ + Vercel ✅ = 環境差異（レア）
```

## 今日の問題を防ぐには？

### プロジェクト作成時のチェックリスト
- [ ] Framework Preset: Other を選択
- [ ] Build Command: 空欄
- [ ] Output Directory: 空欄
- [ ] 最初に /api/ping でテスト
- [ ] Functions タブで関数が見えることを確認

### デプロイ前のチェックリスト
- [ ] `npx vercel dev` で動作確認
- [ ] 環境変数が正しく設定されているか
- [ ] 今日のデプロイ回数を確認（90回超えたら注意）

## まとめ
「ローカルで動くから大丈夫」は危険！
Vercel特有の問題は必ず存在するため、本番環境での動作確認は必須。
ただし、デプロイ回数制限があるので、計画的にテストすることが重要。

**Pro Tip**: 
重要なプロジェクトは最初からProプランも検討。
月$20で、今日のような「デプロイ制限で作業停止」を避けられます。